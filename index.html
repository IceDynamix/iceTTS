<html lang="en">

<head>
    <title>iceTTS - Twitch Chat TTS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.min.js"></script>
</head>

<body class="container mt-3 bg-dark">
    <div class="row g-3">
        <div class="bg-light p-3">
            <h1>iceTTS - Twitch Chat TTS</h1>
        </div>

        <div class="bg-light p-3">
            <h3>Channel Settings</h3>
            <div class="my-3">
                <label for="channel" class="form-label">Channel</label>
                <input type="text" class="form-control" id="channel" />
            </div>
            <button id="connect" class="btn btn-success me-3">Connect</button>
            <button id="disconnect" class="btn btn-danger me-3">Disconnect</button>
            <button id="test" class="btn btn-primary me-3">Test TTS Voice</button>
        </div>

        <div class="bg-light p-3">
            <h3>Speech Settings</h3>
            <div class="row">
                <label for="volume" class="col-2 form-label">Volume</label>
                <input type="range" class="col form-range" min="0" max="1" value="0.25" step="0.1" id="volume" />
                <span class="col-1" id="volume-label">0.25</span>
            </div>
            <div class="row">
                <label for="rate" class="col-2 form-label">Rate</label>
                <input type="range" class="col form-range" min="0.1" max="10" value="1.0" step="0.1" id="rate" />
                <span class="col-1" id="rate-label">1.0</span>
            </div>
            <div class="row">
                <label for="pitch" class="col-2 form-label">Pitch</label>
                <input type="range" class="col form-range" min="0" max="2" value="1.0" step="0.1" id="pitch" />
                <span class="col-1" id="pitch-label">1.0</span>
            </div>
        </div>

        <div class="bg-light p-3">
            <h3>Language Settings</h3>
            <p>Available languages depend on the installed TTS languages</p>

            <label for="default-lang" class="form-label">Default Language</label>
            <select id="default-lang" class="form-select"></select>
            <div class="form-check form-switch mt-3">
                <input class="form-check-input" type="checkbox" id="multi-lang-scan">
                <label class="form-check-label" for="multi-lang-scan">
                    Detect multiple text languages from text
                    content
                </label>
            </div>
        </div>

        <div class="bg-light p-3">
            <h3>Filter Settings</h3>
            <div class="row">
                <div class="col">
                    <label for="replacements" class="form-label">Text Replacements (uses <a
                           href="https://en.wikipedia.org/wiki/Regular_expression">RegEx</a>)</label>
                    <textarea class="form-control" id="replacements" rows="10"
                              style="font-family:monospace;white-space: pre;overflow-wrap: normal;overflow-x: scroll;"></textarea>
                    <p class="invalid-feedback" id="replacements-feedback"></p>
                </div>
                <div class="col-3">
                    <label for="blacklist" class="form-label">User Blacklist</label>
                    <textarea class="form-control" id="blacklist"
                              placeholder="Newline separated list of users" rows="10"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container position-fixed bottom-0 end-0 m-3">
        <div id="toast-connected" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                Connected to Twitch Chat
            </div>
        </div>
        <div id="toast-disconnected" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                Disconnected from Twitch Chat
            </div>
        </div>
    </div>
</body>

<script src="tmi.min.js"></script>
<script src="_languageData.js"></script>
<script src="guessLanguage.js"></script>
<script>
    function tts(text) {
        const speech = new SpeechSynthesisUtterance(text);
        speech.rate = document.querySelector("#rate").value;
        speech.pitch = document.querySelector("#pitch").value;
        speech.volume = document.querySelector("#volume").value;

        if (document.querySelector("#multi-lang-scan").checked) {
            guessLanguage.detect(text, lang => {
                speech.lang = lang === "unknown" ? document.querySelector("#default-lang").value : lang;
                speech.voice = window.speechSynthesis.getVoices().filter(v => v.lang === speech.lang)[0];
                window.speechSynthesis.speak(speech);
            });
        } else {
            speech.lang = document.querySelector("#default-lang").value;
            speech.voice = window.speechSynthesis.getVoices().filter(v => v.lang === speech.lang)[0];
            window.speechSynthesis.speak(speech);
        }
    }
</script>

<script>
    let config = {};

    function saveConfig() {
        localStorage.setItem("iceTtsConfig", JSON.stringify(config));
    }

    function loadConfig() {
        config = JSON.parse(localStorage.getItem("iceTtsConfig"));

        if (config.speechRate) {
            document.querySelector("#rate").value = config.speechRate;
            updateRate();
        }
        if (config.speechVolume) {
            document.querySelector("#volume").value = config.speechVolume;
            updateVolume();
        }
        if (config.speechPitch) {
            document.querySelector("#pitch").value = config.speechPitch;
            updatePitch();
        }
        if (config.channel) document.querySelector("#channel").value = config.channel;
        if (config.multiLangScan) document.querySelector("#multi-lang-scan").checked = config.multiLangScan;
        if (config.blacklist) document.querySelector("#blacklist").value = config.blacklist.join("\n");
        let defaultReplacement = [
            {
                find: "https?:\\/\\/(www\\.)?[-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()!@:%_\\+.~#?&\\/\\/=]*)",
                replace: "$1 url"
            }
        ];

        config.replacements = config.replacements || defaultReplacement;
        document.querySelector("#replacements").value = JSON.stringify(config.replacements, null, 2);
    }

    function updateRate() {
        const rate = this.value;
        config.speechRate = rate;
        document.querySelector("#rate-label").innerHTML = rate;
        saveConfig();
    }

    function updateVolume() {
        const volume = this.value;
        config.speechVolume = volume;
        document.querySelector("#volume-label").innerHTML = volume;
        saveConfig();
    }

    function updatePitch() {
        const pitch = this.value;
        config.speechPitch = pitch;
        document.querySelector("#pitch-label").innerHTML = pitch;
        saveConfig();
    }

    function updateChannel() {
        config.channel = this.value;
        saveConfig();
    }

    function updateMultiLangScan() {
        config.multiLangScan = this.checked;
        saveConfig();
    }

    function updateBlacklist() {
        config.blacklist = this.value.split("\n");
        saveConfig();
    }

    function updateReplacements() {
        let classList = this.classList;
        try {
            config.replacements = JSON.parse(this.value);
            if (classList.contains("is-invalid")) classList.remove("is-invalid");
            classList.add("is-valid");
            saveConfig();
        } catch (error) {
            if (classList.contains("is-valid")) classList.remove("is-valid");
            classList.add("is-invalid");
            document.querySelector("#replacements-feedback").textContent = "JSON is invalid";
        }
    }

    document.querySelector("#rate").addEventListener("input", updateRate);
    document.querySelector("#volume").addEventListener("input", updateVolume);
    document.querySelector("#pitch").addEventListener("input", updatePitch);
    document.querySelector("#channel").addEventListener("input", updateChannel);
    document.querySelector("#multi-lang-scan").addEventListener("change", updateMultiLangScan);
    document.querySelector("#blacklist").addEventListener("input", updateBlacklist);
    document.querySelector("#replacements").addEventListener("input", updateReplacements);

    loadConfig();

    window.speechSynthesis.onvoiceschanged = () => {
        const languages = window.speechSynthesis.getVoices().map(v => v.lang.slice(0, 2)).filter((v, i, self) => self.indexOf(v) === i);
        const langNameMap = {
            "ab": "Abkhazian",
            "af": "Afrikaans",
            "ar": "Arabic",
            "az": "Azeri",
            "be": "Belarusian",
            "bg": "Bulgarian",
            "bn": "Bengali",
            "bo": "Tibetan",
            "br": "Breton",
            "ca": "Catalan",
            "ceb": "Cebuano",
            "cs": "Czech",
            "cy": "Welsh",
            "da": "Danish",
            "de": "German",
            "el": "Greek",
            "en": "English",
            "eo": "Esperanto",
            "es": "Spanish",
            "et": "Estonian",
            "eu": "Basque",
            "fa": "Farsi",
            "fi": "Finnish",
            "fo": "Faroese",
            "fr": "French",
            "fy": "Frisian",
            "gd": "Scots Gaelic",
            "gl": "Galician",
            "gu": "Gujarati",
            "ha": "Hausa",
            "haw": "Hawaiian",
            "he": "Hebrew",
            "hi": "Hindi",
            "hmn": "Pahawh Hmong",
            "hr": "Croatian",
            "hu": "Hungarian",
            "hy": "Armenian",
            "id": "Indonesian",
            "is": "Icelandic",
            "it": "Italian",
            "ja": "Japanese",
            "ka": "Georgian",
            "kk": "Kazakh",
            "km": "Cambodian",
            "ko": "Korean",
            "ku": "Kurdish",
            "ky": "Kyrgyz",
            "la": "Latin",
            "lt": "Lithuanian",
            "lv": "Latvian",
            "mg": "Malagasy",
            "mk": "Macedonian",
            "ml": "Malayalam",
            "mn": "Mongolian",
            "mr": "Marathi",
            "ms": "Malay",
            "nd": "Ndebele",
            "ne": "Nepali",
            "nl": "Dutch",
            "nn": "Nynorsk",
            "no": "Norwegian",
            "nso": "Sepedi",
            "pa": "Punjabi",
            "pl": "Polish",
            "ps": "Pashto",
            "pt": "Portuguese",
            "pt-PT": "Portuguese (Portugal)",
            "pt-BR": "Portuguese (Brazil)",
            "ro": "Romanian",
            "ru": "Russian",
            "sa": "Sanskrit",
            "bs": "Serbo-Croatian",
            "sk": "Slovak",
            "sl": "Slovene",
            "so": "Somali",
            "sq": "Albanian",
            "sr": "Serbian",
            "sv": "Swedish",
            "sw": "Swahili",
            "ta": "Tamil",
            "te": "Telugu",
            "th": "Thai",
            "tl": "Tagalog",
            "tlh": "Klingon",
            "tn": "Setswana",
            "tr": "Turkish",
            "ts": "Tsonga",
            "tw": "Twi",
            "uk": "Ukrainian",
            "ur": "Urdu",
            "uz": "Uzbek",
            "ve": "Venda",
            "vi": "Vietnamese",
            "xh": "Xhosa",
            "zh": "Chinese",
            "zh-TW": "Traditional Chinese (Taiwan)",
            "zu": "Zulu"
        };

        const defaultLanguageSelect = document.querySelector("#default-lang");
        languages.forEach((lang, i) => {
            defaultLanguageSelect.options[i] = new Option(langNameMap[lang], lang);
        });
    };

    let client;

    document.querySelector("#connect").addEventListener("click", () => {
        client = new window.tmi.client({ channels: [document.querySelector("#channel").value] });

        client.on("connected", () => {
            console.log(`Connected to IRC`);
            new bootstrap.Toast(document.getElementById("toast-connected")).show();
        });

        client.on("disconnected", () => {
            console.log(`Disconnected from IRC`);
            new bootstrap.Toast(document.getElementById("toast-disconnected")).show()
        });

        client.on("chat", (target, context, msg, self) => {
            if (self) return;
            if (config.blacklist && config.blacklist.includes(context.username)) return;
            if (config.replacements)
                config.replacements.forEach(({ find, replace }) => msg = msg.replace(new RegExp(find), replace));

            tts(msg);
        });

        client.connect().catch(console.error);
    });

    document.querySelector("#disconnect").addEventListener("click", () => {
        if (client) client.disconnect().catch(console.error);
    });

    document.querySelector("#test").addEventListener("click", () => {
        tts("This is a test message");
    })
</script>

</html>
